<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: header" />
<style>
 .fieldError {
    border-color: #bd2130;
 }
</style>
<body>
<div class="container">
    <div th:replace="fragments/bodyHeader :: bodyHeader"/>
    <form id="store-form" role="form">
        <div class="form-group">
            <label>가게 이름</label>
            <input type="text" name="storeName" class="form-control" placeholder="가게 이름을 입력하세요">
        </div>

        <div class="form-group">
            <label>가게 이미지</label>
            <input type="file" id="imageFile" name="imageFile" class="form-control" accept="image/*">
            <input type="hidden" name="imageUrl"> <!-- presigned 업로드 후 URL을 여기에 저장 -->
        </div>

        <div class="form-group">
            <label>도시</label>
            <input type="text" name="city" class="form-control" placeholder="도시를 입력하세요">
        </div>
        <div class="form-group">
            <label>거리</label>
            <input type="text" name="street" class="form-control" placeholder="거리를 입력하세요">
        </div>
        <div class="form-group">
            <label>우편번호</label>
            <input type="text" name="zipcode" class="form-control" placeholder="우편번호를 입력하세요">
        </div>

        <!-- 카테고리 다중 선택 -->
        <div id="categoryWrapper" class="mb-3">
            <label>카테고리 (최대 2개)</label><br/>
            <div th:each="category : ${categories}">
                <input type="checkbox"
                       name="categoryIds"
                       th:id="'category_' + ${category.id}"
                       th:value="${category.id}"
                       class="category-checkbox">
                <label th:for="'category_' + ${category.id}" th:text="${category.name}"></label><br/>
            </div>
        </div>

        <button type="submit" class="btn btn-primary">가게 등록</button>
    </form>
    <br/>
    <div th:replace="fragments/footer :: footer" />
</div> <!-- /container -->


<script>
document.addEventListener('DOMContentLoaded', () => {

    //체크박스 최대 2개 제한
    document.querySelectorAll('.category-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const checked = document.querySelectorAll('.category-checkbox:checked');
            if (checked.length > 2) {
                checkbox.checked = false;
                alert('카테고리는 최대 2개까지만 선택할 수 있습니다.');
            }
        });
    });

    const form = document.getElementById('store-form');

    form.addEventListener('submit', async (event) => {
        event.preventDefault();

        const fileInput = document.getElementById('imageFile');
        const file = fileInput.files[0];

        //Presigned URL 요청
        const fileRequest = {
            fileName: file.name,
            contentType: file.type
        };

        const presignedResponse = await fetch('/api/files/presigned-url', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(fileRequest)
        });

        if (!presignedResponse.ok) {
            alert("Presigned URL 발급 실패");
            return;
        }

        const { presignedUrl, fileUrl } = await presignedResponse.json();

        //S3에 업로드 (PUT)
        const uploadResponse = await fetch(presignedUrl, {
            method: 'PUT',
            body: file
        });

        if (!uploadResponse.ok) {
            alert("이미지 업로드 실패");
            return;
        }

        //카테고리 선택값 동적으로 수집
        const checkedBoxes = document.querySelectorAll('.category-checkbox:checked');
        const categoryIds = Array.from(checkedBoxes).map(cb => parseInt(cb.value));

        if (categoryIds.length === 0) {
            alert("카테고리를 최소 1개 이상 선택해주세요.");
            return;
        }

        //최종 Store 등록 요청
        const storeRequest = {
            storeName: form.querySelector('input[name="storeName"]').value,
            imageUrl: fileUrl, // S3 업로드된 이미지 URL
            city: form.querySelector('input[name="city"]').value,
            street: form.querySelector('input[name="street"]').value,
            zipcode: form.querySelector('input[name="zipcode"]').value,
            categoryIds: categoryIds
        };

        const storeResponse = await fetch('/api/stores', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(storeRequest)
        });

        if (storeResponse.ok) {
            const result = await storeResponse.json();
            alert("가게 등록 성공! ID: " + result.data.id);
            window.location.href = "/owner/home";
        } else {
            const err = await storeResponse.json();
            alert("가게 등록 실패: " + (err.message || "알 수 없는 오류"));
        }
    });
});
</script>
</body>
</html>
